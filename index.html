<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Sign in</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-page">
    <div class="gov-header" role="banner">
      <div class="gov-header-inner">
        <div class="gov-brand" aria-label="Department of Agrarian Reform">
          <img src="dar_logo.png" alt="DAR logo" class="gov-logo"/>
          <div class="gov-text">
            <div class="gov-supra">Republic of the Philippines</div>
            <div class="gov-agency">Department of Agrarian Reform</div>
            <div class="gov-system">Land Administration System</div>
          </div>
        </div>
      </div>
    </div>
    <div class="centered-wrapper">
    <div class="signup-container" role="region" aria-labelledby="signin-heading">
        <h1 id="signin-heading">Office sign in</h1>
        <p class="page-intro">Use your office account to access this portal.</p>
        <div id="form-error" class="form-error" role="alert" aria-live="polite" hidden></div>
        <form id="loginForm" onsubmit="redirectHome(event)" novalidate>
            <div class="form-group">
                <label for="username">Username or email</label>
                <input type="text" id="username" name="username" placeholder="Enter username or email" autocomplete="username" required aria-required="true">
            </div>
    
            <div class="form-group">
                <label for="password">Password</label>
                  <div style="position:relative;">
                    <input type="password" id="password" name="password" autocomplete="current-password" required aria-required="true" style="padding-right:84px;">
                    <button type="button" id="toggle-password" class="link-btn" aria-pressed="false" aria-controls="password" aria-label="Show password" style="position:absolute; right:12px; top:50%; transform:translateY(-50%);">Show</button>
                  </div>
            </div>
    
            <button type="submit" id="submit-btn" class="signup-btn">
              <span class="btn-label">Sign in</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
        </form>
        <p class="secondary-text">If you are a technician, use the <a class="portal-link" href="https://jam-piodos.github.io/landlord">technician portal</a>.</p>
      </div>
    </div>
    <footer class="gov-footer" role="contentinfo">
      <div class="gov-footer-inner">
        <div>Â© Department of Agrarian Reform</div>
        <div class="gov-footer-meta">For authorized use only</div>
      </div>
    </footer>
  <!-- DAR splash overlay -->
  <div id="dar-splash" aria-hidden="true">
    <div class="logo-wrap">
      <img src="dar_logo.png" alt="DAR logo">
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ozkxzvpiiqhhzbyzetsy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96a3h6dnBpaXFoaHpieXpldHN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMjcwMTksImV4cCI6MjA2NjYwMzAxOX0.ra2xvmu97bESlkHkwvPIKjbbccJbQYyHbbFzbJXa4sU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function redirectHome(event) {
            event.preventDefault();
            const usernameEl = document.getElementById('username');
            const passwordEl = document.getElementById('password');
            const errorEl = document.getElementById('form-error');
            const submitBtn = document.getElementById('submit-btn');
            const btnLabel = submitBtn.querySelector('.btn-label');

            errorEl.hidden = true;
            errorEl.textContent = '';

            const identifier = usernameEl.value.trim();
            const password = passwordEl.value;
            if (!identifier || !password) {
                errorEl.textContent = 'Enter your username and password.';
                errorEl.hidden = false;
                errorEl.focus?.();
                return;
            }

            // Admin backdoor: access admin panel with admin/admin
            if (identifier.toLowerCase() === 'admin' && password === 'admin') {
                window.location.href = 'admin.html#profile';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('user_id, username, user_email, user_password, user_firstname, user_lastname, role, active')
                    .or(`username.eq.${identifier},user_email.eq.${identifier}`)
                    .single();

                if (error || !user) {
                    throw new Error('Invalid credentials.');
                }
                if (user.active === false) {
                    throw new Error('Your account is deactivated.');
                }
                if (String(user.user_password) !== String(password)) {
                    throw new Error('Invalid credentials.');
                }

                // Persist minimal current user for profile modal
                try { localStorage.setItem('ll_current_user', JSON.stringify({
                  user_id: user.user_id,
                  username: user.username,
                  user_email: user.user_email,
                  user_firstname: user.user_firstname,
                  user_lastname: user.user_lastname,
                  role: user.role,
                  active: user.active
                })); } catch {}

                const role = String(user.role || '').toLowerCase();
                if (role === 'office') {
                    showDarSplash('home.html#map');
                    return;
                }
                if (role === 'technician') {
                    window.location.href = 'https://jam-piodos.github.io/landlord';
                    return;
                }

                throw new Error('This portal is for office accounts only.');
            } catch (e) {
                errorEl.textContent = e?.message || 'Login failed. Please try again.';
                errorEl.hidden = false;
                errorEl.focus?.();
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        }
      // Show DAR splash, then navigate
      function showDarSplash(nextUrl) {
        const el = document.getElementById('dar-splash');
        if (!el) { window.location.href = nextUrl; return; }
        el.style.display = 'flex';
        setTimeout(function(){ window.location.href = nextUrl; }, 3000);
      }
      // Show/hide password (accessible)
      document.getElementById('toggle-password').onclick = function() {
        var pwd = document.getElementById('password');
        var isHidden = pwd.type === 'password';
        pwd.type = isHidden ? 'text' : 'password';
        this.setAttribute('aria-pressed', String(isHidden));
        this.textContent = isHidden ? 'Hide' : 'Show';
        this.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
      };
    </script>
    <style>
      :root {
        --bg: #0b0d11;
        --text: #e8ece9;
        --muted: #a6b0a9;
        --card: rgba(15, 18, 22, 0.7);
        --border: rgba(255,255,255,0.08);
        --accent-start: #ff7a18; /* orange */
        --accent-end: #ff3f00;   /* deep orange */
        --focus: #ffd84d;        /* warm focus */
        --header-start: #ff7a18; /* orange */
        --header-end: #111111;  /* black */
        --header-text: #ffffff;
        --input-bg: #12161b;
        --input-border: #2a3138;
        --input-placeholder: #98a2ac;
      }
      body.login-page { background: radial-gradient(1200px 500px at 70% -10%, rgba(255,122,24,0.25), transparent 60%), linear-gradient(180deg, #1a1a1a 0%, #0b0d11 200px); color: var(--text); min-height: 100vh; display:flex; flex-direction:column; }
      .gov-header { background: linear-gradient(135deg, var(--header-start), var(--header-end)); color: var(--header-text); box-shadow: 0 1px 6px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1000; }
      .gov-header-inner { max-width: 1040px; margin: 0 auto; padding: 10px 16px; }
      .gov-brand { display:flex; align-items:center; gap: 12px; }
      .gov-logo { width: 42px; height: 42px; border-radius: 6px; object-fit: contain; background: #fff; padding: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
      .gov-text { line-height: 1.15; }
      .gov-supra { font-size: .8rem; opacity: .9; }
      .gov-agency { font-size: 1.05rem; font-weight: 700; letter-spacing: .2px; }
      .gov-system { font-size: .86rem; opacity: .95; }
      .centered-wrapper {
        width: 100vw;
        height: calc(100vh - 84px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding-top: 24px;
      }
      .signup-container {
        background: var(--card);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 16px;
        box-shadow: 0 18px 48px rgba(0,0,0,0.45);
        padding: 36px 30px 30px 30px;
        max-width: 480px;
        width: 100%;
        margin: 22px auto;
        text-align: center;
        border: 1px solid var(--border);
        border-top: 6px solid var(--accent-start);
      }
      .signup-container h1 { font-size: 1.75rem; margin: 0 0 10px 0; font-weight: 800; letter-spacing: .2px; }
      .page-intro { margin: 0 0 18px 0; color: var(--muted); font-size: .98rem; }
      .form-error { border-left: 4px solid #d4351c; background: #f3f2f1; color:#d4351c; padding: 10px 12px; margin: 0 0 14px 0; text-align:left; border-radius:4px; }
      .form-group label {
        color: var(--text);
        font-size: .98rem;
        margin-bottom: 8px;
        display: block;
        text-align: left;
      }
      .form-group { margin-bottom: 14px; }
      .form-group input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text);
        font-size: 1.05em;
        margin-bottom: 14px;
        outline: none;
        transition: border 0.15s, box-shadow 0.15s, background 0.15s;
      }
      .form-group input:focus {
        border: 1px solid var(--accent-start);
        box-shadow: 0 0 0 3px rgba(255,122,24,0.35);
        background: #0f141a;
      }
      .form-group input::placeholder { color: var(--input-placeholder); }
      /* Make the toggle button align perfectly inside the input */
      #toggle-password { line-height: 1; }
      .signup-btn {
        background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 14px 0;
        font-size: 1.06em;
        font-weight: 700;
        cursor: pointer;
        margin-top: 8px;
        transition: transform 0.15s, box-shadow 0.15s, filter 0.15s;
        width: 100%;
        position: relative;
        box-shadow: 0 8px 24px rgba(255,63,0,0.25);
      }
      .signup-btn:hover {
        filter: brightness(1.05);
        transform: translateY(-1px);
      }
      .signup-btn:focus { outline: none; box-shadow: 0 0 0 3px var(--focus); }
      .signup-btn.loading .btn-label { opacity: 0; }
      .signup-btn.loading .btn-spinner { display: inline-block; }
      .btn-spinner { display:none; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.6); border-top-color: #fff; border-radius: 50%; animation: spin 0.9s linear infinite; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
      @keyframes spin { to { transform: translate(-50%,-50%) rotate(360deg); } }
      .secondary-text { margin-top: 14px; color: var(--muted); font-size: .92rem; }
      .portal-link { color: var(--accent-start); font-weight: 700; text-decoration: none; }
      .portal-link:hover { text-decoration: underline; }
      .link-btn { background: none; border: none; color: var(--accent-start); font-weight: 600; cursor: pointer; padding: 2px 4px; }
      .link-btn:hover { text-decoration: underline; }
      .gov-footer { background: transparent; color: #cbd5e1; border-top: 1px solid rgba(255,255,255,0.08); }
      .gov-footer-inner { max-width: 1040px; margin: 8px auto 18px; padding: 12px 16px; display:flex; align-items:center; justify-content: space-between; flex-wrap: wrap; gap: 8px; font-size: .9rem; }
      .gov-footer-meta { opacity: .9; font-size: .85rem; }

      /* DAR splash overlay */
      #dar-splash { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: radial-gradient(800px 400px at 50% 40%, rgba(255,122,24,0.22), rgba(0,0,0,0.9)); z-index: 2000; }
      #dar-splash .logo-wrap { display:flex; align-items:center; justify-content:center; width: 160px; height:160px; background:#fff; border-radius: 16px; box-shadow: 0 18px 48px rgba(0,0,0,.45); animation: popIn 600ms cubic-bezier(.2,.8,.2,1) 1; }
      #dar-splash img { width: 82%; height: 82%; object-fit: contain; animation: pulse 2.4s ease-in-out infinite; }
      @keyframes popIn { 0% { transform: scale(.85); opacity: 0 } 100% { transform: scale(1); opacity: 1 } }
      @keyframes pulse { 0%, 100% { transform: scale(1) } 50% { transform: scale(1.05) } }
    </style>
</body>
</html>